# Изменения в системе регистрации

## Обзор изменений

Система регистрации была изменена: теперь коды подтверждения отправляются через email вместо использования встроенной системы Supabase OTP.

## Что изменилось

### 1. Новые файлы

#### `lib/config/email_config.dart`
- Содержит все настройки для отправки email
- SMTP настройки (хост, порт, безопасность)
- Учетные данные отправителя
- Шаблоны писем (HTML и текстовый формат)

#### `lib/services/email_service.dart`
- Сервис для отправки кодов подтверждения
- Генерация 6-значных кодов
- Проверка кодов с учетом времени жизни (10 минут)
- Защита от брутфорса (максимум 5 попыток)
- Автоматическая очистка устаревших кодов

#### `EMAIL_CONFIG_SETUP.md`
- Подробная инструкция по настройке email
- Примеры конфигурации для разных почтовых сервисов
- Рекомендации по безопасности
- Устранение типичных проблем

### 2. Измененные файлы

#### `lib/services/auth_service.dart`
**Было:**
- Регистрация создавала пользователя в Supabase сразу
- Код подтверждения отправлялся через Supabase Auth

**Стало:**
- Данные пользователя сохраняются временно (до подтверждения email)
- Код отправляется через email service
- Пользователь создается в Supabase только после подтверждения email
- Добавлен класс `PendingUser` для временного хранения данных

**Изменения в методах:**

1. `signUpWithEmail()`:
   - Теперь сохраняет данные во временное хранилище
   - Отправляет код через `EmailService.sendVerificationCode()`
   - Не создает пользователя до подтверждения

2. `verifyEmailWithOTP()`:
   - Проверяет код через `EmailService.verifyCode()`
   - Создает пользователя в Supabase после успешной проверки
   - Проверяет срок действия данных регистрации (30 минут)

3. `resendVerificationCode()`:
   - Отправляет новый код через `EmailService.sendVerificationCode()`
   - Проверяет наличие данных регистрации

#### `pubspec.yaml`
- Добавлена зависимость `mailer: ^6.0.1`

## Новый процесс регистрации

1. **Пользователь вводит данные**
   - Email, пароль, никнейм

2. **Отправка кода**
   - Данные сохраняются во временном хранилище
   - Генерируется 6-значный код
   - Код отправляется на email
   - Код действителен 10 минут

3. **Подтверждение email**
   - Пользователь вводит код из письма
   - Система проверяет код (максимум 5 попыток)
   - При успехе создается аккаунт в Supabase
   - Данные удаляются из временного хранилища

4. **Повторная отправка**
   - Можно запросить новый код
   - Генерируется новый код
   - Предыдущий код становится недействительным

## Безопасность

### Реализованные меры:
- ✅ Коды действительны 10 минут
- ✅ Максимум 5 попыток ввода кода
- ✅ Данные регистрации истекают через 30 минут
- ✅ Один активный код на email
- ✅ Автоматическое удаление данных после подтверждения

### Рекомендации для продакшена:
- ⚠️ Переместите коды из памяти в базу данных
- ⚠️ Используйте переменные окружения для паролей
- ⚠️ Добавьте rate limiting
- ⚠️ Используйте профессиональный SMTP сервис
- ⚠️ Настройте мониторинг и логирование

## Настройка

Для начала работы:

1. Откройте `lib/config/email_config.dart`
2. Измените следующие параметры:
   ```dart
   static const String senderEmail = 'your-email@gmail.com';
   static const String senderPassword = 'your-app-password';
   ```
3. Смотрите подробные инструкции в `EMAIL_CONFIG_SETUP.md`

## Тестирование

1. Запустите приложение
2. Перейдите на экран регистрации
3. Введите данные и нажмите "Зарегистрироваться"
4. Проверьте почту (включая спам)
5. Введите 6-значный код на экране подтверждения

## Возможные улучшения

- [ ] Хранение кодов в базе данных (Supabase)
- [ ] Использование переменных окружения
- [ ] Rate limiting для отправки писем
- [ ] Добавление reCAPTCHA
- [ ] Аналитика и логирование
- [ ] Кастомизация шаблонов писем через UI
- [ ] Поддержка нескольких языков в письмах

## Откат изменений

Если нужно вернуться к Supabase OTP:

1. Откройте `lib/services/auth_service.dart`
2. Верните старую реализацию методов (сохранена в git истории)
3. Удалите `lib/services/email_service.dart`
4. Удалите `lib/config/email_config.dart`
5. Удалите `mailer` из `pubspec.yaml`
6. Выполните `flutter pub get`


